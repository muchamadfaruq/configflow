<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>VPN Generator Pro - FaruqAdv</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            background: #0f172a;
            color: #e5e7eb;
            font-family: 'Segoe UI', sans-serif;
        }

        .card {
            background: #020617;
            border: 1px solid #1e293b;
            border-radius: 12px;
            transition: 0.3s;
        }

        .card:hover {
            border-color: #3b82f6;
        }

        pre {
            background: #000;
            color: #22c55e;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            border: 1px solid #1e293b;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .form-control {
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
        }

        .text-info-custom {
            color: #3b82f6;
            font-weight: bold;
        }

        .modal-content {
            background: #020617;
            border: 1px solid #1e293b;
            color: white;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .btn-copy-all {
            background: #1e293b;
            color: #3b82f6;
            border: 1px solid #3b82f6;
        }

        .btn-copy-all:hover {
            background: #3b82f6;
            color: white;
        }

        .info-label {
            color: #94a3b8;
            font-size: 0.85rem;
        }

        .info-value {
            color: #f8fafc;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <div class="loading-overlay" id="loader">
        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
        <h5 id="loader-text">üîÑ Memproses...</h5>
    </div>

    <div class="container py-4">
        <div class="text-center mb-4">
            <h2 class="text-info-custom">üöÄ VPN Management FaruqAdv</h2>
            <p class="text-secondary">Sistem Generator & Monitoring Database Pelanggan</p>
        </div>

        <div class="card p-4 mb-4 shadow text-center border-info">
            <div class="d-flex justify-content-center gap-2 flex-wrap">
                <button class="btn btn-primary px-4" onclick="loadFromSheet()">üì° Sinkron Data</button>
                <button class="btn btn-success px-4" onclick="openAutoModal()">‚ûï Tambah Pelanggan</button>
                <a href="https://docs.google.com/spreadsheets/d/1Xo_8UDsiF8KWvoPrWVesfNg9XfO-mTAnyj8ddShD0Pg/edit"
                    target="_blank" class="btn btn-outline-success px-4">üìÇ Buka Sheets</a>
                <button class="btn btn-warning px-4 fw-bold" onclick="downloadCHRConfig()">üì¶ Migrasi CHR
                    (.rsc)</button>
            </div>
        </div>

        <input type="text" id="search" class="form-control py-3 mb-4 shadow-sm"
            placeholder="üîç Cari Nama, Username, atau IP Remote...">

        <div id="output" class="row g-3"></div>
    </div>

    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-info-custom">Input Data Pelanggan Baru</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="vpnForm" class="row g-3">
                        <div class="col-md-2"><label class="small fw-bold">No</label><input type="text" id="in-no"
                                name="no" class="form-control" readonly></div>
                        <div class="col-md-5"><label class="small fw-bold">Nama Pelanggan / User</label><input
                                type="text" name="username" class="form-control" placeholder="Contoh: Budi_Net"
                                required></div>
                        <div class="col-md-5"><label class="small fw-bold">Password VPN</label><input type="text"
                                name="password" class="form-control" value="12345"></div>
                        <div class="col-md-3"><label class="small fw-bold">Remote IP</label><input type="text"
                                id="in-remote" name="remote" class="form-control" required></div>
                        <div class="col-md-3"><label class="small fw-bold">Port Winbox</label><input type="text"
                                id="in-winbox" name="portwinbox" class="form-control" required></div>
                        <div class="col-md-3"><label class="small fw-bold">Port API</label><input type="text"
                                id="in-api" name="portapi" class="form-control" required></div>
                        <div class="col-md-3"><label class="small fw-bold">Port OLT (2000)</label><input type="text"
                                id="in-olt" name="port2000" class="form-control" required></div>
                        <input type="hidden" name="protocol" value="l2tp"><input type="hidden" name="profile"
                            value="default"><input type="hidden" name="local" value="10.9.8.1">
                        <div class="col-12 mt-4"><button type="submit"
                                class="btn btn-primary btn-lg w-100 fw-bold shadow">üöÄ SIMPAN & TERBITKAN
                                SCRIPT</button></div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const CONFIG = {
            DOMAIN: "chr.faruqadv.my.id",
            SHEET_URL: "https://docs.google.com/spreadsheets/d/1Xo_8UDsiF8KWvoPrWVesfNg9XfO-mTAnyj8ddShD0Pg/export?format=csv",
            APPS_SCRIPT: "https://script.google.com/macros/s/AKfycbyA_0KJkzIRoqYuuijEaRVSTG3rbxWYTceiC_yJw66ndUdA6aH_ze3Uv27YoTsUNEfx/exec"
        };

        let clients = [];
        window.onload = loadFromSheet;

        async function openAutoModal() {
            showLoader("üîç Mengambil urutan terakhir...");
            try {
                const res = await fetch(CONFIG.APPS_SCRIPT);
                const last = await res.json();
                document.getElementById('in-no').value = parseInt(last.no) + 1;
                document.getElementById('in-winbox').value = parseInt(last.winbox) + 1;
                document.getElementById('in-api').value = parseInt(last.api) + 1;
                document.getElementById('in-olt').value = parseInt(last.olt) + 1;
                let ipParts = last.remote.split('.');
                ipParts[3] = parseInt(ipParts[3]) + 1;
                document.getElementById('in-remote').value = ipParts.join('.');
                hideLoader();
                new bootstrap.Modal(document.getElementById('addModal')).show();
            } catch (e) { hideLoader(); alert("Gagal koneksi ke server!"); }
        }

        function loadFromSheet() {
            showLoader("üì° Sinkronisasi database...");
            fetch(CONFIG.SHEET_URL + "&cb=" + Date.now()).then(r => r.text()).then(csv => {
                const wb = XLSX.read(csv, { type: 'string' });
                const raw = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { defval: "" });
                clients = raw.map(item => {
                    const newItem = {};
                    for (let key in item) { newItem[key.toLowerCase().replace(/\s+/g, '')] = item[key]; }
                    return newItem;
                });
                render(clients);
                hideLoader();
            });
        }

        // FUNGSI MIGRASI (PENTING)
        function downloadCHRConfig() {
            if (!clients.length) return alert('Data masih kosong, silakan sinkron data dulu!');

            let rscHeader = "/system identity set name=CHR-FaruqAdv\n/interface l2tp-server server set enabled=yes use-ipsec=no\n\n# --- IMPORT SECRET & NAT START ---\n";

            let rscBody = clients.map(c => {
                const u = c.username || "N/A";
                const p = c.password || "12345";
                const rem = c.remote || "";
                const wb = c.portwinbox || "";
                const api = c.portapi || "";
                const olt = c.port2000 || c.portcustom2000 || "";
                const no = c.no || "0";

                return `# PELANGGAN: ${u}\n/ppp secret add local-address=10.9.8.1 name=${u} password=${p} profile=default remote-address=${rem} service=l2tp\n/ip firewall nat add action=dst-nat chain=dstnat dst-port=${wb} protocol=tcp to-addresses=${rem} to-ports=8291 comment="${no}-${u}-Winbox"\n/ip firewall nat add action=dst-nat chain=dstnat dst-port=${api} protocol=tcp to-addresses=${rem} to-ports=8728 comment="${no}-${u}-API"\n/ip firewall nat add action=dst-nat chain=dstnat dst-port=${olt} protocol=tcp to-addresses=${rem} to-ports=2000 comment="${no}-${u}-OLT"`;
            }).join('\n\n');

            let rscFooter = "\n\n# --- IMPORT SELESAI ---";

            const blob = new Blob([rscHeader + rscBody + rscFooter], { type: "text/plain;charset=utf-8" });
            saveAs(blob, "MIGRASI_LENGKAP_CHR.rsc");
        }

        function deleteUser(username) {
            if (!confirm(`Hapus permanen pelanggan: ${username}?`)) return;
            showLoader(`üóëÔ∏è Menghapus data...`);
            fetch(CONFIG.APPS_SCRIPT, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({ action: 'delete', username: username })
            }).then(() => setTimeout(() => { loadFromSheet(); hideLoader(); }, 2000));
        }

        document.getElementById('vpnForm').onsubmit = function (e) {
            e.preventDefault();
            showLoader("üíæ Menyimpan data...");
            fetch(CONFIG.APPS_SCRIPT, { method: 'POST', mode: 'no-cors', body: JSON.stringify(Object.fromEntries(new FormData(this))) })
                .then(() => setTimeout(() => { loadFromSheet(); bootstrap.Modal.getInstance(document.getElementById('addModal')).hide(); hideLoader(); }, 2500));
        };

        function render(data) {
            const out = document.getElementById('output');
            out.innerHTML = '';
            [...data].reverse().forEach((c, i) => {
                const u = c.username || "N/A";
                const p = c.password || "";
                const rem = c.remote || "";
                const wb = c.portwinbox || "";
                const api = c.portapi || "";
                const olt = c.port2000 || c.portcustom2000 || "";
                const no = c.no || "0";

                const srv = `/ppp secret add local-address=10.9.8.1 name=${u} pass=${p} profile=default remote-address=${rem} service=l2tp\n/ip firewall nat add action=dst-nat chain=dstnat dst-port=${wb} protocol=tcp to-addresses=${rem} to-ports=8291 comment="${no}-${u}-Winbox"\n/ip firewall nat add action=dst-nat chain=dstnat dst-port=${api} protocol=tcp to-addresses=${rem} to-ports=8728 comment="${no}-${u}-API"\n/ip firewall nat add action=dst-nat chain=dstnat dst-port=${olt} protocol=tcp to-addresses=${rem} to-ports=2000 comment="${no}-${u}-OLT"`;
                const cli = `/interface l2tp-client add connect-to=${CONFIG.DOMAIN} name="VPN-FaruqAdv-${u}" user=${u} password=${p} disabled=no`;

                const fullTxt = `==== DATA PELANGGAN NO: ${no} ====\nPelanggan: ${u}\nIP Remote: ${rem}\n\n[ SCRIPT SERVER CHR ]\n${srv}\n\n[ SCRIPT CLIENT MIKROTIK ]\n${cli}\n\n--- AKSES REMOTE ---\nüìç Winbox: ${CONFIG.DOMAIN}:${wb}\nüìç API   : ${CONFIG.DOMAIN}:${api}\nüìç OLT   : ${CONFIG.DOMAIN}:${olt}`;

                out.innerHTML += `
                <div class="col-md-6">
                    <div class="card p-3 h-100 shadow border-secondary">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div><h4 class="text-info-custom mb-0">${u}</h4><small class="text-secondary">No. Urut: ${no} | IP: ${rem}</small></div>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${u}')">üóëÔ∏è Hapus</button>
                        </div>
                        <div class="mb-3"><div class="row g-2">
                                <div class="col-6"><div class="bg-dark p-2 rounded border border-secondary"><span class="info-label">Winbox Port</span><br><span class="info-value text-warning">${wb}</span></div></div>
                                <div class="col-6"><div class="bg-dark p-2 rounded border border-secondary"><span class="info-label">OLT/Web Port</span><br><span class="info-value text-info">${olt}</span></div></div>
                        </div></div>
                        <pre id="code-${i}">${fullTxt}</pre>
                        <div class="d-grid gap-2 mt-2">
                            <button class="btn btn-primary btn-sm fw-bold" onclick="copyTxt('${cli}', this)">üìã Copy Script Client</button>
                            <button class="btn btn-copy-all btn-sm" onclick="copyFromID('code-${i}', this)">üìÑ Copy Info Lengkap</button>
                        </div>
                    </div>
                </div>`;
            });
        }

        function showLoader(msg) { document.getElementById('loader-text').innerText = msg; document.getElementById('loader').style.display = 'flex'; }
        function hideLoader() { document.getElementById('loader').style.display = 'none'; }
        function copyTxt(text, btn) { navigator.clipboard.writeText(text).then(() => { const old = btn.innerText; btn.innerText = '‚úÖ Berhasil Disalin!'; setTimeout(() => btn.innerText = old, 1500); }); }
        function copyFromID(id, btn) { copyTxt(document.getElementById(id).innerText, btn); }
    </script>
</body>

</html>