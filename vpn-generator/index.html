<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>VPN Generator Mikrotik - FaruqAdv</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        body {
            background: #0f172a;
            color: #e5e7eb;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }

        .card {
            background: #020617;
            border: 1px solid #1e293b;
            border-radius: 12px;
        }

        pre {
            background: #000;
            color: #22c55e;
            padding: 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            border: 1px solid #1e293b;
            max-height: 250px;
            overflow-y: auto;
        }

        .form-control {
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
        }

        .form-control:focus {
            background: #1e293b;
            color: white;
            border-color: #3b82f6;
            box-shadow: none;
        }

        .text-info-custom {
            color: #3b82f6;
            font-weight: bold;
        }

        .badge-protocol {
            text-transform: uppercase;
            font-size: 0.7rem;
        }

        #auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        #main-content {
            display: none;
        }
    </style>
</head>

<body>
    <div id="auth-screen">
        <div class="card p-4 text-center shadow-lg" style="width: 350px;">
            <h4 class="mb-3 text-info-custom">üîí Protected Area</h4>
            <p class="small text-secondary">FaruqAdv VPN System</p>
            <input type="password" id="passInput" class="form-control mb-3 text-center" placeholder="Password">
            <button class="btn btn-primary w-100" onclick="checkPass()">Masuk</button>
        </div>
    </div>

    <div class="container py-4" id="main-content">
        <div class="text-center mb-4">
            <h3 class="text-info-custom">üöÄ VPN Generator Mikrotik</h3>
            <p class="text-secondary">FaruqAdv Edition</p>
        </div>

        <div class="card p-4 mb-4 shadow text-center">
            <div class="d-flex justify-content-center gap-2 flex-wrap">
                <button class="btn btn-primary px-4" onclick="loadFromSheet()">üì° Sinkron Data</button>
                <a href="https://docs.google.com/spreadsheets/d/1Xo_8UDsiF8KWvoPrWVesfNg9XfO-mTAnyj8ddShD0Pg/edit"
                    target="_blank" class="btn btn-outline-success px-4">üìë Buka Spreadsheet</a>
                <button class="btn btn-warning px-4" onclick="downloadCHRConfig()">üì¶ Download Script CHR Saja</button>
            </div>
        </div>

        <div class="row g-2 mb-4">
            <div class="col-md-12">
                <input type="text" id="search" class="form-control py-3"
                    placeholder="üîç Cari Nama Client, User, atau IP Remote...">
            </div>
        </div>

        <div id="output" class="row g-3"></div>
    </div>

    <script>
        // --- BAGIAN UPDATE GAMPANG DI SINI ---
        const CONFIG = {
            PASSWORD: "adminfaruqadv",
            DOMAIN: "chr.faruqadv.my.id", // Update Domain di sini saja
            SHEET_URL: "https://docs.google.com/spreadsheets/d/1Xo_8UDsiF8KWvoPrWVesfNg9XfO-mTAnyj8ddShD0Pg/export?format=csv"
        };

        let clients = [];

        function checkPass() {
            const input = document.getElementById('passInput').value;
            if (input === CONFIG.PASSWORD) {
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                loadFromSheet();
            } else {
                alert('Password Salah!');
            }
        }

        document.getElementById('passInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPass(); });

        function normalizeData(data) {
            return data.map(item => {
                const newItem = {};
                for (let key in item) {
                    const cleanKey = key.toLowerCase().replace(/\s+/g, '');
                    newItem[cleanKey] = item[key];
                }
                return newItem;
            });
        }

        function loadFromSheet() {
            fetch(CONFIG.SHEET_URL)
                .then(res => res.text())
                .then(csv => {
                    const wb = XLSX.read(csv, { type: 'string' });
                    const sheetName = wb.SheetNames[0];
                    const rawJson = XLSX.utils.sheet_to_json(wb.Sheets[sheetName], { defval: "" });
                    clients = normalizeData(rawJson);
                    render(clients);
                })
                .catch(err => alert("Gagal mengambil data dari Google Sheets."));
        }

        function buildOutput(c) {
            const u = c.username || "N/A";
            const p = c.password || "";
            const rem = c.remote || "";
            const loc = c.local || "10.9.8.1";
            const proto = (c.protocol || "l2tp").toLowerCase();
            const prof = c.profile || "default";
            const winbox = c.portwinbox || "";
            const api = c.portapi || "";
            const olt = c.portcustom2000 || "";
            const no = c.no || "0";

            // SCRIPT KHUSUS SERVER (CHR)
            const serverOnly = `/ppp secret add local-address=${loc} name=${u} pass=${p} profile="${prof}" remote-address=${rem} service=${proto}
/ip firewall nat add action=dst-nat chain=dstnat dst-port=${winbox} protocol=tcp to-addresses=${rem} to-ports=8291 comment="${no}-${u}-winbox"
/ip firewall nat add action=dst-nat chain=dstnat dst-port=${api} protocol=tcp to-addresses=${rem} to-ports=8728 comment="${no}-${u}-API"
/ip firewall nat add action=dst-nat chain=dstnat dst-port=${olt} protocol=tcp to-addresses=${rem} to-ports=2000 comment="${no}-${u}-OLT"`;

            // SCRIPT CLIENT (Otomatis pakai CONFIG.DOMAIN)
            const clientScript = `/interface ${proto}-client add connect-to=${CONFIG.DOMAIN} name=VPN-faruqadv user=${u} password=${p} disabled=no`;

            return {
                server: serverOnly,
                client: clientScript,
                // INFO LOGIN (Otomatis pakai CONFIG.DOMAIN)
                full: `[ SCRIPT SERVER CHR ]\n${serverOnly}\n\n[ SCRIPT CLIENT MIKROTIK ]\n${clientScript}\n\n--- INFO LOGIN ---\nUser: ${u} | Pass: ${p}\nRemote IP: ${rem}\n\nüìç Port Winbox : ${CONFIG.DOMAIN}:${winbox}\nüìç Port API    : ${CONFIG.DOMAIN}:${api}\nüìç Port 2000   : ${CONFIG.DOMAIN}:${olt}`
            };
        }

        function render(data) {
            const container = document.getElementById('output');
            container.innerHTML = '';
            data.forEach((c, i) => {
                const scripts = buildOutput(c);
                const card = document.createElement('div');
                card.className = 'col-md-6';
                card.innerHTML = `
                    <div class="card p-3 h-100 shadow-sm">
                        <div class="d-flex justify-content-between mb-2">
                            <h5 class="text-info-custom mb-0">${c.username || 'Unnamed'}</h5>
                            <span class="badge bg-success badge-protocol">${c.protocol || 'L2TP'}</span>
                        </div>
                        <pre id="code-${i}">${scripts.full}</pre>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="copyTextDirect('${scripts.client}', this)">üìã Copy Script CLIENT</button>
                            <button class="btn btn-outline-warning btn-sm" onclick="copyTextDirect('${scripts.server}', this)">üñ•Ô∏è Copy Script CHR Saja</button>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        function copyTextDirect(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const old = btn.innerText;
                btn.innerText = '‚úÖ Tersalin!';
                setTimeout(() => btn.innerText = old, 1500);
            });
        }

        function downloadCHRConfig() {
            if (!clients.length) return alert('Data belum ditarik!');
            const allCHR = clients.map(c => buildOutput(c).server).join('\n\n');
            const blob = new Blob([allCHR], { type: 'text/plain' });
            saveAs(blob, 'MIGRASI_CHR_ONLY.rsc');
        }

        document.getElementById('search').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            const filtered = clients.filter(c =>
                (c.username || '').toLowerCase().includes(q) ||
                (c.remote || '').includes(q) ||
                (c.protocol || '').toLowerCase().includes(q)
            );
            render(filtered);
        });
    </script>
</body>

</html>